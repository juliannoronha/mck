<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>User Productivity</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #444;
        }
        th {
            background-color: #333;
        }
        .button {
            display: inline-block;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin-top: 20px;
        }
        .button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <table>
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Total Submissions</th>
                    <th>Total Pouches Checked</th>
                    <th>Average Time Duration</th>
                    <th>Average Pouches per Hour</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="user : ${users}">
                    <td th:text="${user.username}"></td>
                    <td th:text="${user.totalSubmissions}"></td>
                    <td th:text="${user.totalPouchesChecked}"></td>
                    <td th:text="${user.avgTimeDuration}"></td>
                    <td th:text="${#numbers.formatDecimal(user.avgPouchesPerHour, 1, 2)}"></td>
                </tr>
            </tbody>
        </table>
        <a href="/view-responses" class="button">Back to Responses</a>
    </div>

    <script th:inline="javascript">
        const table = document.querySelector('table tbody');

        function fetchAndUpdateProductivity() {
            console.log('Fetching all user productivity data...');
            fetch('/api/all-user-productivity')
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(users => {
                    console.log('Received user productivity data:', users);
                    updateTable(users);
                })
                .catch(error => {
                    console.error('Error fetching user productivity data:', error);
                });
        }

        function updateTable(users) {
            table.innerHTML = '';
            users.forEach(user => {
                const row = `
                    <tr>
                        <td>${user.username}</td>
                        <td>${user.totalSubmissions}</td>
                        <td>${user.totalPouchesChecked}</td>
                        <td>${user.avgTimeDuration}</td>
                        <td>${user.avgPouchesPerHour.toFixed(2)}</td>
                    </tr>
                `;
                table.innerHTML += row;
            });
            console.log('Table updated with new data');
        }

        // Fetch data immediately and then every 10 seconds
        fetchAndUpdateProductivity();
        setInterval(fetchAndUpdateProductivity, 10000);
    </script>
</body>
</html>